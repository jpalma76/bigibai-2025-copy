---
import { actions } from "astro:actions"; 
---

<section class="w-md md:w-full max-w-xl mx-auto">
  <form 
    method="post" 
    id="newsletter-form" 
    class="flex flex-col gap-4" 
    action={actions.newsletter}
  >
    <div class="flex flex-col md:flex-row gap-3">
      <input 
        name="email" 
        class="w-full !px-6 !py-2 border bg-black/50 border-brand/50 rounded-lg backdrop-blur-lg placeholder:text-white/50 focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent transition-all" 
        type="email"
        required
        placeholder="Ingresa tu email" 
      />
      
      <button 
        type="submit"
        class="!px-6 !py-3 bg-brand hover:bg-yellow-400 text-black font-bold rounded-lg transition all hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
      >
        ¡Avísame!
      </button>
    </div>

    <div id="newsletter-message" class=" hidden text-sm text-center text-brand font-bold z-20"></div>
  </form>
</section>

<script>
  import { actions, isInputError } from "astro:actions";
  import { throwConfetti } from "@/utils/confetti";

  const form = document.getElementById('newsletter-form') as HTMLFormElement
  const message = document.getElementById("newsletter-message") as HTMLDivElement

  message.classList.add("hidden")
  function removeColorMessages() {
    message.classList.remove("text-red-500", "text-green-500", "text-brand")
  }

  form?.addEventListener("submit", async (event) => {
    
    event.preventDefault()

    const formData = new FormData(form)
    const email = formData.get("email") as string

    const { data, error } = await actions.newsletter({ email })

    if(error) {
      const messageText = isInputError(error) 
        ? error?.fields?.email?.join(", ") ?? ""
        : error.message;
      message.textContent = 
        messageText  ?? ""

      message.classList.remove("text-green-500")
      message.classList.remove("hidden")
      message.classList.remove("text-brand")
      message.classList.add("text-red-500")
    }
    /* si el correo no está registrado se guarda */
    if(data?.success) {
      throwConfetti()
      message.classList.remove("text-red-500")
      message.classList.remove("text-brand")
      message.classList.add("text-green-500")
      message.classList.remove("hidden")
      message.textContent = data.message
    }

    if (data?.message && !data?.success) {
      message.classList.remove("text-red-500")
      message.classList.remove("text-green-500")
      message.classList.add("text-brand")
      message.textContent = data.message
      message.classList.remove("hidden")
    }

    setTimeout(() => {
        form.reset()
        removeColorMessages()
        message.classList.add("hidden")
        message.textContent = ""
      }, 5000);
    
  })


</script>